<div class="container">
  <div class="header">
    <h1>Hebrew Text Sectioning Tool</h1>
    <div class="shortcuts">
      <div class="shortcut"><kbd>Enter</kbd> Split into child</div>
      <div class="shortcut"><kbd>Tab</kbd> Split into sibling</div>
      <div class="shortcut"><kbd>Shift+Enter</kbd> Merge with parent</div>
      <div class="shortcut"><kbd>Shift+Tab</kbd> Merge with previous sibling</div>
    </div>
  </div>

  <div class="main-grid">
    <!-- Left Panel: Recursive Text Inputs -->
    <div class="left-panel">
      <h2>Text Sections</h2>
      <div class="instructions">
        Place cursor where you want to split. Text from cursor to end will move to new section.
      </div>

      <div class="nodes-container">
        <ng-container *ngTemplateOutlet="nodeTree; context: {nodes: rootNodes, parent: null, siblings: rootNodes, level: 0}"></ng-container>
      </div>
    </div>

    <!-- Right Panel: XML Output -->
    <div class="right-panel">
      <div class="output-header">
        <h2>XML Output</h2>
        <div class="output-actions">
          <button class="btn btn-secondary" (click)="copyXML()" [disabled]="!xmlOutput">
            Copy
          </button>
          <button class="btn btn-secondary" (click)="downloadXML()" [disabled]="!xmlOutput">
            Download
          </button>
          <button class="btn btn-danger" (click)="clearAll()">
            Clear All
          </button>
        </div>
      </div>
      <pre class="xml-output" dir="ltr">{{ xmlOutput || 'XML will appear here as you create sections...' }}</pre>
    </div>
  </div>
</div>

<!-- Recursive template for nodes -->
<ng-template #nodeTree let-nodes="nodes" let-parent="parent" let-siblings="siblings" let-level="level">
  <div class="node-list">
    <div *ngFor="let node of nodes; let i = index" class="node-wrapper" [style.margin-left.px]="level * 20">
      <div class="node-container">
        <div class="node-header">
          <span class="level-indicator">Level {{ level + 1 }}</span>

          <div class="label-container" (click)="startEditingLabel($event, node)">
            <input
              *ngIf="node.isEditing"
              type="text"
              [(ngModel)]="node.label"
              (keydown)="onLabelKeydown($event, node)"
              (blur)="onLabelBlur(node)"
              [attr.data-node-id]="node.id"
              placeholder="Add label..."
              class="label-input"
              dir="rtl"
            />
            <span *ngIf="!node.isEditing" class="label-display" [class.empty]="!node.label">
              {{ node.label || 'Click to add label' }}
            </span>
          </div>

          <button class="btn-delete" (click)="deleteNode(node, siblings)" title="Delete this section">
            Ã—
          </button>
        </div>

        <textarea
          [(ngModel)]="node.text"
          (keydown)="onTextareaKeydown($event, node, parent, siblings)"
          (input)="generateXML()"
          class="node-textarea"
          [placeholder]="'Enter text... (Level ' + (level + 1) + ')'"
          dir="rtl"
          rows="3"
        ></textarea>

        <!-- Children nodes -->
        <div *ngIf="node.children.length > 0" class="children">
          <ng-container *ngTemplateOutlet="nodeTree; context: {nodes: node.children, parent: node, siblings: node.children, level: level + 1}"></ng-container>
        </div>
      </div>
    </div>
  </div>
</ng-template>
